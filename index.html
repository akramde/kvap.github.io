<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<title>Video Fetcher</title>
<style>
body { font-family: sans-serif; direction: rtl; }
.source { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
</style>
</head>
<body>
<h2>استخراج روابط المشغلات</h2>

<label>ID: <input id="id" /></label><br>
<label>IMDB ID: <input id="imdb" /></label><br>
<label>الاسم: <input id="title" /></label><br>
<label>السنة: <input id="year" /></label><br>
<button onclick="start()">ابدأ</button>

<div id="output"></div>

<script>
async function start(){
  const id = document.getElementById('id').value;
  const imdb = document.getElementById('imdb').value;
  const title = encodeURIComponent(document.getElementById('title').value);
  const year = document.getElementById('year').value;

  const base = `https://lam.maxvol.pro/lite/events?life=true&id=${id}&imdb_id=${imdb}&title=${title}&original_title=${title}&year=${year}`;

  const res = await fetch(base);
  const j1 = await res.json();
  const memkey = j1.memkey;

  const lifeUrl = `https://lam.maxvol.pro/lifeevents?memkey=${memkey}`;
  const res2 = await fetch(lifeUrl);
  const j2 = await res2.json();

  const sources = j2.online.filter(s => s.show);

  const resultDiv = document.getElementById('output');
  resultDiv.innerHTML = '';

  for(const s of sources){
    const infoUrl = `${s.url}?id=${id}&imdb_id=${imdb}&title=${title}&original_title=${title}&year=${year}`;
    const html = await (await fetch(infoUrl)).text();

    // استخراج شامل لكل JSON حتى لو كان متعدد الأسطر أو داخل سكربت
    const jsonBlocks = [];

    // 1) التقاط data-json
    const direct = [...html.matchAll(/data-json=\"([\s\S]*?)\"/g)];
    direct.forEach(m => jsonBlocks.push(m[1]));

    // 2) التقاط JSON داخل وسوم <script>
    const scripts = [...html.matchAll(/<script[^>]*>([\s\S]*?)<\/script>/g)];
    for(const sc of scripts){
      const inner = sc[1];
      const scriptJson = [...inner.matchAll(/\{[\s\S]*?\}/g)];
      scriptJson.forEach(j => jsonBlocks.push(j[0]));
    }

    // 3) محاولة إيجاد روابط mpd/m3u8 مباشرة
    const directLinks = [...html.matchAll(/https?:\/\/[^"'<> ]+\.(mpd|m3u8)/g)].map(m => m[0]);

    const urls = [];

    // تحليل JSON
    for(const block of jsonBlocks){
      try{
        const fixed = block.replace(/&quot;/g,'"');
        const obj = JSON.parse(fixed);
        if(obj.url) urls.push(obj.url);
      }catch(e){/* تجاهل */}
    }

    // إضافة الروابط المباشرة
    directLinks.forEach(l => urls.push(l));

    const box = document.createElement('div');
    box.className = 'source';
    box.innerHTML = `<h3>${s.name}</h3>` + (urls.length ? urls.map(u => `<div>${u}</div>`).join('') : '<div>لا توجد روابط</div>');

    resultDiv.appendChild(box);
  }
}
</script>

</body>
</html>
