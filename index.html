<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>KVAP IMDb JSON Extractor</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/json-formatter-js@2.3.3/dist/json-formatter.min.css" />
</head>
<body>

<div id="json-formatter-container"></div>

<script src="https://cdn.jsdelivr.net/npm/json-formatter-js@2.3.3/dist/json-formatter.umd.min.js"></script>
<script>
async function fetchNamy(imdb) {
    const url = `https://api.namy.ws/embed/imdb/${imdb}`;
    const res = await fetch(url);
    const text = await res.text();

    const mkMatch = text.match(/<script data-name="mk">([\s\S]*?)<\/script>/);
    if (!mkMatch) return null;

    const makePlayerMatch = mkMatch[1].match(/makePlayer\(([\s\S]*?)\);/);
    if (!makePlayerMatch) return null;

    let dataStr = makePlayerMatch[1];

    let data;
    try {
        data = (new Function("return " + dataStr))();
        return {
            dash: data.source.dash || data.source.dasha || "Not found",
            hls: ("hls" in data.source) ? data.source.hls : "Not found",
            cc: data.source.cc || []
        };
    } catch (err) {
        console.error("Error evaluating Namy data:", err);
        return null;
    }
}

async function fetchVK(imdb) {
    try {
        const allohaURL = `https://api.alloha.tv/?token=d317441359e505c343c2063edc97e7&imdb=${imdb}`;
        const kpRes = await fetch(allohaURL);
        const kpData = await kpRes.json();
        const kpId = kpData?.data?.id_kp;
        if (!kpId) return [];

        const playlistURL = `https://plapi.cdnvideohub.com/api/v1/player/sv/playlist?pub=12&aggr=kp&id=${kpId}`;
        const playlistRes = await fetch(playlistURL);
        const playlistData = await playlistRes.json();
        const items = playlistData?.items || playlistData?.data?.items || [];

        let results = [];
        for (let item of items) {
            const vkId = item.vkId;
            if (!vkId) continue;
            const videoURL = `https://plapi.cdnvideohub.com/api/v1/player/sv/video/${vkId}`;
            const videoRes = await fetch(videoURL);
            const videoData = await videoRes.json();
            results.push({
                source: "VK",
                vkId,
                hls: videoData?.sources?.hlsUrl || "Not found",
                dash: videoData?.sources?.dashUrl || "Not found"
            });
        }
        return results;
    } catch (err) {
        console.warn("VK extraction failed:", err.message);
        return [];
    }
}

(async function() {
    try {
        const params = new URLSearchParams(location.search);
        const imdb = params.get("imdb");
        if (!imdb) throw new Error("IMDb ID not found in URL query (?imdb=...)");

        let results = [];

        const vkData = await fetchVK(imdb);
        results = results.concat(vkData);

        const namyData = await fetchNamy(imdb);
        if (namyData) {
            results.push({
                source: "Namy",
                dash: namyData.dash,
                hls: namyData.hls,
                cc: namyData.cc
            });
        }

        // عرض JSON بشكل جميل
        const container = document.getElementById("json-formatter-container");
        const formatter = new JSONFormatter(results, 2, { theme: 'dark' });
        container.appendChild(formatter.render());

    } catch (err) {
        const container = document.getElementById("json-formatter-container");
        container.textContent = JSON.stringify({ error: err.message }, null, 2);
    }
})();
</script>

</body>
</html>
