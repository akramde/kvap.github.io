<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<title>Video Fetcher Pro - Crawler</title>
<style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; direction: rtl; background-color: #f4f4f9; padding: 20px; }
    h2 { color: #333; }
    .input-group { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
    label { display: block; margin-top: 10px; font-weight: bold; font-size: 14px; color: #555; }
    input { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
    button { margin-top: 20px; padding: 12px 20px; background-color: #6610f2; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%; font-weight: bold; }
    button:hover { background-color: #520dc2; }
    
    .source { background: white; margin: 15px 0; padding: 15px; border-right: 5px solid #28a745; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-radius: 4px; }
    .source h3 { margin-top: 0; color: #28a745; border-bottom: 1px solid #eee; padding-bottom: 10px; font-size: 18px; }
    
    .link-item { margin-bottom: 8px; padding: 10px; background: #f8f9fa; border-radius: 4px; word-break: break-all; border: 1px solid #e9ecef; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap;}
    .link-info { flex: 1; }
    .link-item a { text-decoration: none; color: #007bff; font-weight: bold; display: block; margin-top: 5px; font-size: 14px; }
    
    /* Tags Colors */
    .tag { padding: 3px 8px; font-size: 12px; border-radius: 4px; color: white; font-weight: normal; margin-left: 5px; display: inline-block; margin-bottom: 2px;}
    .tag-play { background-color: #28a745; } /* فيديو */
    .tag-sub { background-color: #17a2b8; } /* ترجمة */
    .tag-audio { background-color: #d63384; } /* صوت */
    .tag-deep { background-color: #6f42c1; } /* تم فتحه */
    
    /* Status */
    .status-checking { background-color: #ffc107; color: black; animation: blink 1s infinite; }
    .status-working { background-color: #28a745; color: white; }
    .status-broken { background-color: #dc3545; color: white; }

    @keyframes blink { 50% { opacity: 0.6; } }

    .loader { display: none; text-align: center; margin-top: 20px; font-weight: bold; color: #555; }
    .loader-detail { font-size: 12px; color: #888; display: block; margin-top: 5px; }
</style>
</head>
<body>

<h2>الزاحف الذكي (فيديو + صوت + ترجمة)</h2>

<div class="input-group">
    <label>ID (TMDB/Lampa): <input id="id" value="1309012" /></label>
    <label>IMDB ID: <input id="imdb" value="tt32123395" /></label>
    <label>Kinopoisk ID: <input id="kp_id" value="6638362" /></label>
    <label>الاسم: <input id="title" value="Альтер" /></label>
    <label>الاسم الأصلي: <input id="orig_title" value="Altered" /></label>
    <label>السنة: <input id="year" value="2025" /></label>
</div>

<button type="button" onclick="startCrawler()">تشغيل الزاحف واستخراج كل شيء</button>

<div id="loader" class="loader">
    جاري العمل...
    <span id="loader-text" class="loader-detail"></span>
</div>
<div id="output"></div>

<script>
const parser = new DOMParser();

async function startCrawler(){
  // جمع البيانات
  const params = {
      id: document.getElementById('id').value,
      imdb: document.getElementById('imdb').value,
      kp_id: document.getElementById('kp_id').value,
      title: encodeURIComponent(document.getElementById('title').value),
      orig_title: encodeURIComponent(document.getElementById('orig_title').value),
      year: document.getElementById('year').value
  };
  
  const outputDiv = document.getElementById('output');
  const loader = document.getElementById('loader');
  const loaderText = document.getElementById('loader-text');

  outputDiv.innerHTML = '';
  loader.style.display = 'block';
  loaderText.textContent = 'جاري الاتصال بالسيرفر الرئيسي...';

  const base = `https://lam.maxvol.pro/lite/events?life=true&id=${params.id}&imdb_id=${params.imdb}&kinopoisk_id=${params.kp_id}&title=${params.title}&original_title=${params.orig_title}&year=${params.year}`;

  try {
      const res = await fetch(base);
      const j1 = await res.json();
      
      if(!j1.memkey) throw new Error("لم يتم العثور على مفتاح memkey.");
      
      const lifeUrl = `https://lam.maxvol.pro/lifeevents?memkey=${j1.memkey}`;
      const res2 = await fetch(lifeUrl);
      const j2 = await res2.json();

      const sources = j2.online.filter(s => s.show);
      
      if(sources.length === 0) {
          loader.style.display = 'none';
          outputDiv.innerHTML = '<div style="padding:20px; color:red">لا توجد مصادر.</div>';
          return;
      }

      loaderText.textContent = `تم العثور على ${sources.length} مصدر. جاري الزحف العميق...`;

      // معالجة كل مصدر
      const promises = sources.map(async (s) => {
        const infoUrl = `${s.url}?id=${params.id}&imdb_id=${params.imdb}&kinopoisk_id=${params.kp_id}&title=${params.title}&original_title=${params.orig_title}&year=${params.year}`;
        
        try {
            // استدعاء دالة الزحف (Crawl)
            const allLinks = await crawlLink(infoUrl, s.name, 0);
            return { source: s, links: allLinks };
        } catch (e) {
            return { source: s, error: e.message };
        }
      });

      const results = await Promise.all(promises);
      loader.style.display = 'none';

      // عرض النتائج
      renderResults(results, outputDiv);

  } catch (e) {
      loader.style.display = 'none';
      outputDiv.innerHTML = `<div style="padding:20px; color:red">حدث خطأ: ${e.message}</div>`;
  }
}

/**
 * دالة الزحف (Crawl)
 * 1. تجلب المحتوى.
 * 2. تستخرج كل شيء (فيديو، ترجمة، صوت).
 * 3. إذا وجدت رابط تصفح، تفتحه وتكرر العملية.
 */
async function crawlLink(url, sourceName, depth) {
    if(depth > 2) return []; // حماية من التكرار اللانهائي (عمق 2 يكفي للمواسم/الحلقات)

    try {
        const response = await fetch(url);
        const html = await response.text();
        const doc = parser.parseFromString(html, 'text/html');
        const elements = doc.querySelectorAll('[data-json]');
        
        let extractedItems = [];
        let navigationLinks = [];

        elements.forEach(el => {
            try {
                let jsonStr = el.getAttribute('data-json');
                if(!jsonStr) return;
                
                jsonStr = jsonStr.replace(/&quot;/g, '"');
                const obj = JSON.parse(jsonStr);
                
                let label = obj.title || obj.translate || obj.name || 'Unknown';
                if (obj.voice_name) label += ` (${obj.voice_name})`;
                if (obj.maxquality) label += ` [${obj.maxquality}]`;

                // 1. استخراج الروابط المباشرة (فيديو)
                if(obj.url && isVideoLink(obj.url)) {
                    extractedItems.push(createItem(obj.url, label, 'play'));
                } 
                else if (obj.url) {
                    // إذا لم يكن فيديو، فهو رابط تصفح (مجلد/موسم)
                    navigationLinks.push(obj.url);
                }

                if(obj.stream) extractedItems.push(createItem(obj.stream, label + ' (Stream)', 'play'));
                
                // 2. استخراج الجودات (فيديو)
                if(obj.quality && typeof obj.quality === 'object') {
                    Object.keys(obj.quality).forEach(q => {
                        extractedItems.push(createItem(obj.quality[q], `${label} [${q}]`, 'play'));
                    });
                }

                // 3. استخراج الترجمات (Subtitles/CC)
                if(obj.subtitles && Array.isArray(obj.subtitles)) {
                    obj.subtitles.forEach(sub => {
                        extractedItems.push(createItem(sub.url, `CC: ${sub.label || 'Unknown'}`, 'subtitle'));
                    });
                }
                // بعض المصادر تضع الترجمة في cc
                if(obj.cc) {
                     extractedItems.push(createItem(obj.cc, `CC: External`, 'subtitle'));
                }

                // 4. استخراج الصوتيات المنفصلة (نادر)
                if(obj.audio || obj.sound) {
                    extractedItems.push(createItem(obj.audio || obj.sound, `${label} (Audio Track)`, 'audio'));
                }

            } catch(e) {}
        });

        // 5. إذا وجدنا روابط تصفح، نفتحها الآن (Recursion)
        if(navigationLinks.length > 0) {
            const nestedPromises = navigationLinks.map(link => crawlLink(link, sourceName, depth + 1));
            const nestedResults = await Promise.all(nestedPromises);
            // دمج النتائج
            nestedResults.forEach(res => extractedItems = extractedItems.concat(res));
        }

        // 6. Regex Fallback (للروابط المباشرة في النص)
        if(depth === 0) {
            const regexLinks = [...html.matchAll(/https?:\/\/[^"'<>\s]+\.(mpd|m3u8|mp4)/g)];
            regexLinks.forEach(match => {
                if(!extractedItems.find(d => d.url === match[0])) {
                    extractedItems.push(createItem(match[0], 'رابط مباشر (Regex)', 'play'));
                }
            });
        }

        return extractedItems;

    } catch (e) {
        console.error(`Error processing ${url}`, e);
        return [];
    }
}

// دالة مساعدة للتحقق هل الرابط فيديو
function isVideoLink(url) {
    if(!url) return false;
    return url.match(/\.(mp4|mkv|m3u8|mpd)/i) || url.includes('stream') || url.includes('manifest');
}

function createItem(url, label, type) {
    if(url && url.includes(" or ")) url = url.split(" or ")[0].trim();
    return { url: url, label: label, type: type };
}

// دالة العرض والفحص
function renderResults(results, container) {
    results.forEach(item => {
        if(item.error) return;
        const box = document.createElement('div');
        box.className = 'source';
        
        // تصفية التكرار
        const unique = [];
        const map = new Map();
        item.links.forEach(l => {
            if(!map.has(l.url)) { map.set(l.url, true); unique.push(l); }
        });

        if(unique.length === 0) {
            box.innerHTML = `<h3>${item.source.name} <small>(0)</small></h3><div style="color:#777">فارغ.</div>`;
            container.appendChild(box);
            return;
        }

        let html = unique.map((u, idx) => {
            const uid = `lnk-${item.source.balanser}-${idx}`;
            
            let tagHTML = '';
            let btnCheck = '';

            if(u.type === 'play') {
                tagHTML = '<span class="tag tag-play">فيديو</span>';
                // فحص تلقائي للفيديو
                checkUrl(u.url, uid);
            } else if (u.type === 'subtitle') {
                tagHTML = '<span class="tag tag-sub">ترجمة CC</span>';
                // فحص تلقائي للترجمة
                checkUrl(u.url, uid);
            } else if (u.type === 'audio') {
                tagHTML = '<span class="tag tag-audio">صوت</span>';
            }

            return `
            <div class="link-item">
                <div class="link-info">
                    <div>
                        ${tagHTML}
                        <span id="status-${uid}" class="tag status-checking" style="display:${u.type!=='audio'?'inline-block':'none'}">فحص...</span>
                        <strong>${u.label}</strong>
                    </div>
                    <a href="${u.url}" target="_blank">${u.url}</a>
                </div>
            </div>`;
        }).join('');

        box.innerHTML = `<h3>${item.source.name} <small>(${unique.length})</small></h3><div class="link-group">${html}</div>`;
        container.appendChild(box);
    });
}

// دالة الفحص (HEAD Request)
async function checkUrl(url, id) {
    const el = document.getElementById(`status-${id}`);
    if(!el) return;

    try {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 6000);
        
        const res = await fetch(url, { method: 'HEAD', mode: 'no-cors', signal: controller.signal });
        clearTimeout(timeout);
        
        el.textContent = "يعمل";
        el.className = "tag status-working";
    } catch {
        el.textContent = "لا يعمل/محظور";
        el.className = "tag status-broken";
    }
}
</script>

</body>
</html>
