<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<title>Video Fetcher Ultimate + Validator</title>
<style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; direction: rtl; background-color: #f4f4f9; padding: 20px; }
    h2 { color: #333; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
    button { margin-top: 20px; padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%; }
    button:hover { background-color: #218838; }
    .source { background: white; margin: 15px 0; padding: 15px; border-right: 5px solid #007bff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-radius: 4px; }
    .source h3 { margin-top: 0; color: #007bff; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .link-group { margin-top: 10px; border-top: 1px dashed #ccc; padding-top: 10px; }
    .link-item { margin-bottom: 8px; padding: 10px; background: #f1f1f1; border-radius: 4px; word-break: break-all; border: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap;}
    .link-info { flex: 1; }
    .link-item a { text-decoration: none; color: #0056b3; font-weight: bold; display: block; margin-top: 5px; }
    
    .tag { padding: 3px 8px; font-size: 12px; border-radius: 12px; color: white; font-weight: normal; margin-left: 5px; white-space: nowrap; }
    .tag-play { background-color: #28a745; } 
    .tag-link { background-color: #ffc107; color: #333; }
    .tag-iframe { background-color: #17a2b8; }
    .tag-unknown { background-color: #6c757d; } 

    /* Status Tags */
    .status-checking { background-color: #ffc107; color: black; }
    .status-working { background-color: #28a745; color: white; }
    .status-broken { background-color: #dc3545; color: white; }

    .loader { display: none; text-align: center; margin-top: 20px; font-weight: bold; color: #555; }
    .error-msg { color: red; padding: 10px; background: #ffe6e6; border: 1px solid red; border-radius: 4px; margin-top: 10px; }
</style>
</head>
<body>

<h2>استخراج وفحص الروابط</h2>

<label>ID: <input id="id" value="464475" /></label>
<label>IMDB ID: <input id="imdb" value="tt0021884" /></label>
<label>الاسم: <input id="title" value="Frankenstein" /></label>
<label>السنة: <input id="year" value="1931" /></label>

<button type="button" onclick="start()">ابدأ البحث والفحص</button>

<div id="loader" class="loader">جاري جلب المصادر...</div>
<div id="output"></div>

<script>
async function start(){
  const id = document.getElementById('id').value;
  const imdb = document.getElementById('imdb').value;
  const title = encodeURIComponent(document.getElementById('title').value);
  const year = document.getElementById('year').value;
  const outputDiv = document.getElementById('output');
  const loader = document.getElementById('loader');

  outputDiv.innerHTML = '';
  loader.style.display = 'block';
  loader.textContent = 'جاري الاتصال بالمصادر...';

  const base = `https://lam.maxvol.pro/lite/events?life=true&id=${id}&imdb_id=${imdb}&title=${title}&original_title=${title}&year=${year}`;

  try {
      const res = await fetch(base);
      const j1 = await res.json();
      if(!j1.memkey) throw new Error("No memkey found.");
      
      const lifeUrl = `https://lam.maxvol.pro/lifeevents?memkey=${j1.memkey}`;
      const res2 = await fetch(lifeUrl);
      const j2 = await res2.json();

      const sources = j2.online.filter(s => s.show);
      
      if(sources.length === 0) {
          outputDiv.innerHTML = '<div class="error-msg">لا توجد مصادر.</div>';
          loader.style.display = 'none';
          return;
      }

      // Fetch all sources
      const promises = sources.map(async (s) => {
        const infoUrl = `${s.url}?id=${id}&imdb_id=${imdb}&title=${title}&original_title=${title}&year=${year}`;
        try {
            const response = await fetch(infoUrl);
            const html = await response.text();
            return { source: s, html: html };
        } catch (e) {
            return { source: s, error: e.message };
        }
      });

      const results = await Promise.all(promises);
      loader.style.display = 'none';

      const parser = new DOMParser();

      // Process results
      for(const item of results){
        if(item.error) continue;

        const s = item.source;
        const html = item.html;
        const doc = parser.parseFromString(html, 'text/html');
        const elements = doc.querySelectorAll('[data-json]');
        
        let extractedData = [];

        // Extraction Logic
        elements.forEach(el => {
            try {
                let jsonStr = el.getAttribute('data-json');
                if(jsonStr) {
                    jsonStr = jsonStr.replace(/&quot;/g, '"');
                    const obj = JSON.parse(jsonStr);
                    let label = obj.title || obj.translate || obj.name || 'بدون عنوان';
                    if (obj.voice_name) label += ` (${obj.voice_name})`;
                    
                    if(obj.url) extractedData.push(createLinkObj(obj.url, label, obj.method || 'url'));
                    if(obj.stream) extractedData.push(createLinkObj(obj.stream, label + ' (Stream)', 'stream'));
                    if(obj.iframe) extractedData.push(createLinkObj(obj.iframe, label + ' (Iframe)', 'iframe'));
                    if(obj.quality && typeof obj.quality === 'object') {
                        Object.keys(obj.quality).forEach(q => {
                            extractedData.push(createLinkObj(obj.quality[q], `${label} [${q}]`, 'quality'));
                        });
                    }
                }
            } catch(e) {}
        });

        const regexLinks = [...html.matchAll(/https?:\/\/[^"'<>\s]+\.(mpd|m3u8|mp4)/g)];
        regexLinks.forEach(match => {
            if(!extractedData.find(d => d.url === match[0])) {
                extractedData.push(createLinkObj(match[0], 'رابط مباشر (Regex)', 'regex'));
            }
        });

        // Remove duplicates
        const uniqueData = [];
        const map = new Map();
        for (const item of extractedData) {
            if(!map.has(item.url)){
                map.set(item.url, true);
                uniqueData.push(item);
            }
        }

        // Generate HTML
        const box = document.createElement('div');
        box.className = 'source';
        
        let linksHtml = uniqueData.map((u, index) => {
            let tagClass = 'tag-unknown';
            let tagText = 'رابط';
            if (u.type === 'play' || u.type === 'stream' || u.url.match(/\.(m3u8|mpd|mp4)/)) {
                tagClass = 'tag-play'; tagText = 'تشغيل';
            } else if (u.type === 'link') {
                tagClass = 'tag-link'; tagText = 'تصفح';
            }

            // Unique ID for checking
            const linkId = `link-${s.balanser}-${index}`;

            // If it's a direct video link, trigger check immediately
            if(tagText === 'تشغيل') {
                checkLink(u.url, linkId);
            }

            return `
            <div class="link-item" id="container-${linkId}">
                <div class="link-info">
                    <div>
                        <span class="tag ${tagClass}">${tagText}</span>
                        <span id="status-${linkId}" class="tag status-checking" style="display:${tagText==='تشغيل'?'inline-block':'none'}">جاري الفحص...</span>
                        <strong>${u.label}</strong>
                    </div>
                    <a href="${u.url}" target="_blank">${u.url}</a>
                </div>
            </div>`;
        }).join('');

        if(uniqueData.length === 0) linksHtml = '<div style="padding:10px; color:#777">لا روابط.</div>';

        box.innerHTML = `<h3>${s.name} <small>(${uniqueData.length})</small></h3><div class="link-group">${linksHtml}</div>`;
        outputDiv.appendChild(box);
      }

  } catch (e) {
      loader.style.display = 'none';
      outputDiv.innerHTML = `<div class="error-msg">حدث خطأ: ${e.message}</div>`;
  }
}

function createLinkObj(url, label, type) {
    if(url.includes(" or ")) url = url.split(" or ")[0].trim();
    return { url: url, label: label, type: type };
}

// Function to check if a link is working
async function checkLink(url, elementId) {
    const statusSpan = document.getElementById(`status-${elementId}`);
    if(!statusSpan) return;

    try {
        // Note: Because of CORS (security policy), we can't fully verify external video links 
        // purely from client-side JS without a proxy.
        // However, we can try a fetch. If it fails due to CORS, it usually means the server exists 
        // but blocks browser requests (which often implies the link is technically 'alive').
        // If it returns 404, it's dead.
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout

        const response = await fetch(url, { 
            method: 'HEAD', 
            mode: 'no-cors', // Important for external video links
            signal: controller.signal 
        });
        
        clearTimeout(timeoutId);

        // With no-cors, we get an opaque response. We assume it's working if no network error.
        statusSpan.textContent = "يعمل (Active)";
        statusSpan.className = "tag status-working";

    } catch (error) {
        console.error(error);
        statusSpan.textContent = "لا يعمل / محظور";
        statusSpan.className = "tag status-broken";
    }
}
</script>

</body>
</html>
