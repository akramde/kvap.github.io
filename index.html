<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>KVAP Multi HLS/DASH Extractor</title>
</head>
<body>

<h2>Extract HLS & DASH (with Voice Studio)</h2>

<input id="imdbInput" placeholder="Enter IMDb ID مثل: tt0241527" style="width:250px;">
<button onclick="start()">Start</button>

<pre id="output" style="white-space: pre-wrap; background:#eee; padding:10px;"></pre>

<script>
async function start() {
    const imdb = document.getElementById("imdbInput").value.trim();
    const out = document.getElementById("output");
    out.textContent = "Processing...";

    try {
        // Step 1 — IMDb → Kinopoisk ID
        const allohaURL = `https://api.alloha.tv/?token=d317441359e505c343c2063edc97e7&imdb=${imdb}`;
        const kpRes = await fetch(allohaURL);
        const kpData = await kpRes.json();
        const kpId = kpData?.data?.id_kp;
        if (!kpId) throw new Error("Kinopoisk ID not found!");

        // Step 2 — Get playlist with multiple items
        const playlistURL = `https://plapi.cdnvideohub.com/api/v1/player/sv/playlist?pub=12&aggr=kp&id=${kpId}`;
        const playlistRes = await fetch(playlistURL);
        const playlistData = await playlistRes.json();

        const items = playlistData?.items || playlistData?.data?.items;
        if (!items || items.length === 0) throw new Error("No vkId items found!");

        let results = [];

        // Step 3 — Loop through all vkId items
        for (let item of items) {
            const vkId = item.vkId;
            const voiceStudio = item.voiceStudio || "Unknown";

            if (!vkId) continue;

            // Request video info
            const videoURL = `https://plapi.cdnvideohub.com/api/v1/player/sv/video/${vkId}`;
            const videoRes = await fetch(videoURL);
            const videoData = await videoRes.json();

            const hls = videoData?.sources?.hlsUrl;
            const dash = videoData?.sources?.dashUrl;

            results.push({
                vkId,
                voiceStudio,
                hls: hls || "Not found",
                dash: dash || "Not found"
            });
        }

        // Step 4 — Output results
        out.textContent = JSON.stringify(results, null, 2);

    } catch (err) {
        out.textContent = "❌ Error: " + err.message;
    }
}
</script>

</body>
</html>
