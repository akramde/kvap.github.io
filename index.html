<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>KVAP Extractor</title>
</head>
<body>

<h2>Extract</h2>

<input id="imdbInput" placeholder="Enter IMDb ID مثل: tt0241527" style="width:250px;">
<button onclick="start()">Start</button>

<pre id="output" style="white-space: pre-wrap; background:#eee; padding:10px;"></pre>

<script>
async function start() {
    const imdb = document.getElementById("imdbInput").value.trim();
    const out = document.getElementById("output");
    out.textContent = "Processing...";

    try {

        // 1️⃣ Step 1 — IMDb → Kinopoisk ID
        const allohaURL = `https://api.alloha.tv/?token=d317441359e505c343c2063edc97e7&imdb=${imdb}`;
        const kpRes = await fetch(allohaURL);
        const kpData = await kpRes.json();
        console.log(kpData);

        const kpId = kpData.id_kp || kpData.kinopoisk_id;

        if (!kpId) throw new Error("Kinopoisk ID not found!");

        // 2️⃣ Step 2 — Kinopoisk → vkId
        const playlistURL = `https://plapi.cdnvideohub.com/api/v1/player/sv/playlist?pub=12&aggr=kp&id=${kpId}`;
        const playlistRes = await fetch(playlistURL);
        const playlistData = await playlistRes.json();

        const vkId = playlistData?.data?.items?.[0]?.vkId;
        if (!vkId) throw new Error("vkId not found!");

        // 3️⃣ Step 3 — vkId → video info
        const videoURL = `https://plapi.cdnvideohub.com/api/v1/player/sv/video/${vkId}`;
        const videoRes = await fetch(videoURL);
        const videoData = await videoRes.json();

        const hls = videoData?.hls;
        const dash = videoData?.dash;

        if (!hls && !dash) throw new Error("HLS or DASH not found!");

        // 4️⃣ Output results
        out.textContent =
            "Kinopoisk ID: " + kpId + "\n" +
            "vkId: " + vkId + "\n\n" +
            "HLS:\n" + hls + "\n\n" +
            "DASH:\n" + dash;

    } catch (err) {
        out.textContent = "❌ Error: " + err.message;
    }
}
</script>

</body>
</html>
