<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<title>Video Fetcher Deep Scan</title>
<style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; direction: rtl; background-color: #f4f4f9; padding: 20px; }
    h2 { color: #333; }
    .input-group { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
    label { display: block; margin-top: 10px; font-weight: bold; font-size: 14px; color: #555; }
    input { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
    button { margin-top: 20px; padding: 12px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%; font-weight: bold; }
    button:hover { background-color: #0056b3; }
    
    .source { background: white; margin: 15px 0; padding: 15px; border-right: 5px solid #28a745; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-radius: 4px; }
    .source h3 { margin-top: 0; color: #28a745; border-bottom: 1px solid #eee; padding-bottom: 10px; font-size: 18px; display: flex; justify-content: space-between;}
    
    .link-item { margin-bottom: 8px; padding: 10px; background: #f8f9fa; border-radius: 4px; word-break: break-all; border: 1px solid #e9ecef; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap;}
    .link-info { flex: 1; }
    .link-item a { text-decoration: none; color: #007bff; font-weight: bold; display: block; margin-top: 5px; font-size: 14px; }
    .link-item a:hover { text-decoration: underline; }

    .tag { padding: 3px 8px; font-size: 12px; border-radius: 4px; color: white; font-weight: normal; margin-left: 5px; white-space: nowrap; display: inline-block; margin-bottom: 2px;}
    .tag-play { background-color: #28a745; } 
    .tag-deep { background-color: #6610f2; } /* لون للروابط المستخرجة من العمق */
    .tag-iframe { background-color: #17a2b8; }
    .tag-unknown { background-color: #6c757d; } 

    .status-checking { background-color: #ffc107; color: black; animation: blink 1s infinite; }
    .status-working { background-color: #28a745; color: white; }
    .status-broken { background-color: #dc3545; color: white; }

    @keyframes blink { 50% { opacity: 0.6; } }

    .loader { display: none; text-align: center; margin-top: 20px; font-weight: bold; color: #555; }
    .loader-detail { font-size: 12px; color: #888; display: block; margin-top: 5px; }
    .error-msg { color: red; padding: 10px; background: #ffe6e6; border: 1px solid red; border-radius: 4px; margin-top: 10px; }
</style>
</head>
<body>

<h2>استخراج عميق وفحص الروابط</h2>

<div class="input-group">
    <label>ID (TMDB/Lampa ID): <input id="id" value="1309012" /></label>
    <label>IMDB ID: <input id="imdb" value="tt32123395" /></label>
    <label>Kinopoisk ID: <input id="kp_id" value="6638362" /></label>
    <label>الاسم (Title): <input id="title" value="Альтер" /></label>
    <label>الاسم الأصلي (Original Title): <input id="orig_title" value="Altered" /></label>
    <label>السنة: <input id="year" value="2025" /></label>
</div>

<button type="button" onclick="start()">ابدأ البحث العميق</button>

<div id="loader" class="loader">
    جاري العمل...
    <span id="loader-text" class="loader-detail"></span>
</div>
<div id="output"></div>

<script>
// متغيرات عالمية للتحكم
const parser = new DOMParser();

async function start(){
  const id = document.getElementById('id').value;
  const imdb = document.getElementById('imdb').value;
  const kp_id = document.getElementById('kp_id').value;
  const title = encodeURIComponent(document.getElementById('title').value);
  const orig_title = encodeURIComponent(document.getElementById('orig_title').value);
  const year = document.getElementById('year').value;
  
  const outputDiv = document.getElementById('output');
  const loader = document.getElementById('loader');
  const loaderText = document.getElementById('loader-text');

  outputDiv.innerHTML = '';
  loader.style.display = 'block';
  loaderText.textContent = 'جاري جلب المفتاح...';

  const base = `https://lam.maxvol.pro/lite/events?life=true&id=${id}&imdb_id=${imdb}&kinopoisk_id=${kp_id}&title=${title}&original_title=${orig_title}&year=${year}`;

  try {
      // 1. جلب المفتاح والمصادر
      const res = await fetch(base);
      const j1 = await res.json();
      
      if(!j1.memkey) throw new Error("لم يتم العثور على memkey.");
      
      const lifeUrl = `https://lam.maxvol.pro/lifeevents?memkey=${j1.memkey}`;
      const res2 = await fetch(lifeUrl);
      const j2 = await res2.json();

      const sources = j2.online.filter(s => s.show);
      
      if(sources.length === 0) {
          outputDiv.innerHTML = '<div class="error-msg">لا توجد مصادر.</div>';
          loader.style.display = 'none';
          return;
      }

      loaderText.textContent = `تم العثور على ${sources.length} مصدر. جاري الفحص العميق...`;

      // 2. معالجة كل مصدر بشكل متسلسل (لتجنب حظر الطلبات الكثيرة) أو متوازي
      // سنستخدم Promise.all للتوازي لكن مع الحذر
      const promises = sources.map(async (s) => {
        const infoUrl = `${s.url}?id=${id}&imdb_id=${imdb}&kinopoisk_id=${kp_id}&title=${title}&original_title=${orig_title}&year=${year}`;
        
        try {
            // هنا نستدعي دالة البحث العميق
            const deepResults = await deepFetch(infoUrl, s.name);
            return { source: s, results: deepResults };
        } catch (e) {
            return { source: s, error: e.message };
        }
      });

      const results = await Promise.all(promises);
      loader.style.display = 'none';

      // 3. عرض النتائج
      for(const item of results){
        if(item.error) continue;

        const s = item.source;
        const extractedData = item.results;

        // عرض النتائج
        const box = document.createElement('div');
        box.className = 'source';
        
        let linksHtml = extractedData.map((u, index) => {
            let tagClass = 'tag-unknown';
            let tagText = 'رابط';
            let shouldCheck = false;

            if (u.type === 'play' || u.type === 'stream' || u.type === 'quality' || u.type === 'regex' || u.url.match(/\.(m3u8|mpd|mp4)/)) {
                tagClass = 'tag-play'; tagText = 'تشغيل';
                shouldCheck = true;
            } else if (u.type === 'iframe') {
                tagClass = 'tag-iframe'; tagText = 'تضمين';
            } else if (u.isDeep) {
                tagClass = 'tag-deep'; tagText = 'مستخرج';
                shouldCheck = true;
            }

            const linkId = `link-${s.balanser}-${index}`;

            // بدء الفحص فوراً للروابط القابلة للتشغيل
            if(shouldCheck) {
                checkLink(u.url, linkId);
            }

            return `
            <div class="link-item">
                <div class="link-info">
                    <div style="margin-bottom:4px;">
                        <span class="tag ${tagClass}">${tagText}</span>
                        <span id="status-${linkId}" class="tag status-checking" style="display:${shouldCheck?'inline-block':'none'}">جاري الفحص...</span>
                        <strong>${u.label}</strong>
                    </div>
                    <a href="${u.url}" target="_blank">${u.url}</a>
                </div>
            </div>`;
        }).join('');

        if(extractedData.length === 0) linksHtml = '<div style="padding:10px; color:#777">فارغ.</div>';

        box.innerHTML = `<h3>${s.name} <small>(${extractedData.length})</small></h3><div class="link-group">${linksHtml}</div>`;
        outputDiv.appendChild(box);
      }

  } catch (e) {
      loader.style.display = 'none';
      outputDiv.innerHTML = `<div class="error-msg">حدث خطأ: ${e.message}</div>`;
  }
}

/**
 * دالة البحث العميق (Recursive Fetch)
 * تقوم بفتح الرابط، وإذا وجدت روابط "تصفح" تقوم بفتحها أيضاً
 */
async function deepFetch(url, sourceName, depth = 0) {
    // تحديد عمق البحث لتجنب الدوران اللانهائي (مستوى واحد يكفي غالباً للمواسم/الحلقات)
    if (depth > 1) return []; 

    try {
        const response = await fetch(url);
        const html = await response.text();
        const doc = parser.parseFromString(html, 'text/html');
        const elements = doc.querySelectorAll('[data-json]');
        
        let results = [];
        
        // قائمة للروابط التي تحتاج فتح (مجلدات/مواسم)
        let foldersToOpen = [];

        elements.forEach(el => {
            try {
                let jsonStr = el.getAttribute('data-json');
                if(jsonStr) {
                    jsonStr = jsonStr.replace(/&quot;/g, '"');
                    const obj = JSON.parse(jsonStr);
                    
                    let label = obj.title || obj.translate || obj.name || 'Video';
                    if (obj.voice_name) label += ` (${obj.voice_name})`;
                    if (obj.maxquality) label += ` [${obj.maxquality}]`;
                    
                    // إذا كان الرابط من نوع "link" أو تصفح، نضيفه لقائمة الفتح
                    if (obj.method === 'link' && obj.url) {
                        foldersToOpen.push({ url: obj.url, label: label });
                    } 
                    // إذا كان رابط فيديو مباشر
                    else {
                        if(obj.url) results.push(createLinkObj(obj.url, label, obj.method || 'url', depth > 0));
                        if(obj.stream) results.push(createLinkObj(obj.stream, label + ' (Stream)', 'stream', depth > 0));
                        if(obj.iframe) results.push(createLinkObj(obj.iframe, label + ' (Iframe)', 'iframe', depth > 0));
                        
                        if(obj.quality && typeof obj.quality === 'object') {
                            Object.keys(obj.quality).forEach(q => {
                                results.push(createLinkObj(obj.quality[q], `${label} [${q}]`, 'quality', depth > 0));
                            });
                        }
                    }
                }
            } catch(e) {}
        });

        // Regex Fallback (للمستوى 0 فقط لتجنب التكرار)
        if (depth === 0) {
            const regexLinks = [...html.matchAll(/https?:\/\/[^"'<>\s]+\.(mpd|m3u8|mp4)/g)];
            regexLinks.forEach(match => {
                if(!results.find(d => d.url === match[0])) {
                    results.push(createLinkObj(match[0], 'رابط مباشر (Regex)', 'regex', false));
                }
            });
        }

        // الآن نقوم بفتح الروابط التي وجدناها (foldersToOpen)
        if (foldersToOpen.length > 0) {
            // تحديث حالة التحميل للمستخدم
            document.getElementById('loader-text').textContent = `فتح محتويات داخلية لـ ${sourceName}...`;
            
            const folderPromises = foldersToOpen.map(folder => deepFetch(folder.url, sourceName, depth + 1));
            const folderResults = await Promise.all(folderPromises);
            
            // دمج النتائج
            folderResults.forEach(res => {
                results = results.concat(res);
            });
        }

        return results;

    } catch (e) {
        console.error(`Error fetching ${url}:`, e);
        return [];
    }
}

function createLinkObj(url, label, type, isDeep = false) {
    if(url && url.includes(" or ")) url = url.split(" or ")[0].trim();
    return { url: url, label: label, type: type, isDeep: isDeep };
}

// دالة الفحص
async function checkLink(url, elementId) {
    const statusSpan = document.getElementById(`status-${elementId}`);
    if(!statusSpan) return;

    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 7000);

        const response = await fetch(url, { 
            method: 'HEAD', 
            mode: 'no-cors', 
            signal: controller.signal 
        });
        
        clearTimeout(timeoutId);
        statusSpan.textContent = "متاح / يعمل";
        statusSpan.className = "tag status-working";

    } catch (error) {
        statusSpan.textContent = "لا يعمل / مهلة";
        statusSpan.className = "tag status-broken";
    }
}
</script>

</body>
</html>
