<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<title>Video Fetcher</title>
<style>
body { font-family: sans-serif; direction: rtl; }
.source { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
</style>
</head>
<body>
<h2>استخراج روابط المشغلات</h2>

<label>ID: <input id="id" /></label><br>
<label>IMDB ID: <input id="imdb" /></label><br>
<label>الاسم: <input id="title" /></label><br>
<label>السنة: <input id="year" /></label><br>
<button onclick="start()">ابدأ</button>

<div id="output"></div>

<script>
async function start(){
  const id = document.getElementById('id').value;
  const imdb = document.getElementById('imdb').value;
  const title = encodeURIComponent(document.getElementById('title').value);
  const year = document.getElementById('year').value;

  const base = `https://lam.maxvol.pro/lite/events?life=true&id=${id}&imdb_id=${imdb}&title=${title}&original_title=${title}&year=${year}`;

  const resultDiv = document.getElementById('output');
  resultDiv.innerHTML = 'جاري البحث...';

  try {
      const res = await fetch(base);
      const j1 = await res.json();
      const memkey = j1.memkey;

      const lifeUrl = `https://lam.maxvol.pro/lifeevents?memkey=${memkey}`;
      const res2 = await fetch(lifeUrl);
      const j2 = await res2.json();

      const sources = j2.online.filter(s => s.show);
      resultDiv.innerHTML = '';

      for(const s of sources){
        const infoUrl = `${s.url}?id=${id}&imdb_id=${imdb}&title=${title}&original_title=${title}&year=${year}`;
        
        try {
            const html = await (await fetch(infoUrl)).text();

            // استخدام DOMParser بدلاً من Regex لضمان الدقة
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const items = doc.querySelectorAll('[data-json]');
            
            const extractedUrls = [];

            items.forEach(item => {
                try {
                    const jsonStr = item.getAttribute('data-json');
                    const obj = JSON.parse(jsonStr);
                    
                    // تجميع الروابط الممكنة
                    if(obj.url) extractedUrls.push({link: obj.url, type: 'url', method: obj.method, title: obj.title || 'Unknown'});
                    if(obj.stream) extractedUrls.push({link: obj.stream, type: 'stream', method: obj.method, title: obj.title || 'Unknown'});
                    
                    // استخراج الجودات المختلفة إن وجدت
                    if(obj.quality) {
                        Object.values(obj.quality).forEach(qLink => {
                             extractedUrls.push({link: qLink, type: 'quality', method: obj.method, title: obj.title || 'Unknown'});
                        });
                    }

                } catch(e) { console.error('JSON Parse Error', e); }
            });

            // 3) محاولة إيجاد روابط mpd/m3u8 مباشرة من النص (احتياطي)
            const directLinks = [...html.matchAll(/https?:\/\/[^"'<> ]+\.(mpd|m3u8|mp4)/g)].map(m => m[0]);
            directLinks.forEach(l => extractedUrls.push({link: l, type: 'regex', title: 'Direct Regex'}));

            // إنشاء واجهة العرض
            const box = document.createElement('div');
            box.className = 'source';
            
            let linksHtml = '';
            if (extractedUrls.length) {
                // فلترة التكرار
                const unique = [...new Map(extractedUrls.map(item => [item.link, item])).values()];
                
                linksHtml = unique.map(u => {
                    let color = 'black';
                    let note = '';
                    
                    // تمييز الروابط التي تحتاج تصفح إضافي
                    if (u.method === 'link') {
                        color = 'orange';
                        note = ' (رابط تصفح - يحتاج فتح)';
                    } else if (u.link.includes('.m3u8') || u.link.includes('.mpd')) {
                        color = 'green';
                        note = ' (فيديو مباشر)';
                    }

                    return `<div style="color:${color}; margin-bottom: 5px; word-break: break-all;">
                                <strong>${u.title}:</strong> <a href="${u.link}" target="_blank">${u.link}</a> ${note}
                            </div>`;
                }).join('');
            } else {
                linksHtml = '<div>لا توجد روابط مباشرة (قد يكون المحتوى محمياً أو يحتاج تفاعل JS)</div>';
            }

            box.innerHTML = `<h3>${s.name} (${extractedUrls.length})</h3>${linksHtml}`;
            resultDiv.appendChild(box);

        } catch (fetchErr) {
            console.error(fetchErr);
        }
      }
  } catch (e) {
      resultDiv.innerHTML = `حدث خطأ: ${e.message}`;
  }
}
</script>

</body>
</html>
